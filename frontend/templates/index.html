<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Detection - Phone Camera</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        #video {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #333;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #canvas {
            display: none;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        #detections {
            text-align: left;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .detection-item {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #4CAF50;
        }
        .detection-label {
            font-weight: bold;
            color: #333;
        }
        .detection-confidence {
            color: #666;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Card Detection - Phone Camera</h1>
        
                 <div class="controls">
             <button id="startBtn">Start Camera</button>
             <button id="stopBtn" disabled>Stop Camera</button>
             <button id="toggleDetectionBtn" disabled>Toggle Detection</button>
             <button id="testPermissionsBtn">Test Permissions</button>
         </div>
        
                 <div id="status" class="status-info">Click "Start Camera" to begin</div>
         <div id="browser-warning" style="display: none; background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; margin: 10px 0; border: 1px solid #ffeaa7;">
             <strong>Browser Compatibility:</strong> For best results, use Chrome or Firefox. Safari may have limited camera access.
         </div>
        
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
        
        <div id="detections">
            <h3>Detections:</h3>
            <div id="detectionsList">No detections yet</div>
        </div>
    </div>

    <script>
        let stream = null;
        let isDetecting = false;
        let detectionInterval = null;
        let frameCount = 0;
        const maxFps = 5; // Limit to 5 FPS to reduce server load
        
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
                 const startBtn = document.getElementById('startBtn');
         const stopBtn = document.getElementById('stopBtn');
         const toggleDetectionBtn = document.getElementById('toggleDetectionBtn');
         const testPermissionsBtn = document.getElementById('testPermissionsBtn');
                 const status = document.getElementById('status');
         const detectionsList = document.getElementById('detectionsList');
         const browserWarning = document.getElementById('browser-warning');
         
         // Check browser compatibility
         function checkBrowserCompatibility() {
             const userAgent = navigator.userAgent;
             console.log('User Agent:', userAgent);
             console.log('mediaDevices available:', !!navigator.mediaDevices);
             console.log('getUserMedia available:', !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia));
             
             if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                 browserWarning.style.display = 'block';
             }
                  }
         
         async function testPermissions() {
             try {
                 updateStatus('Testing camera permissions...', 'info');
                 
                 // Test if getUserMedia works
                 if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                     updateStatus('getUserMedia not supported in this browser', 'error');
                     return;
                 }
                 
                 // Try to get a very short camera access
                 const testStream = await navigator.mediaDevices.getUserMedia({ video: true });
                 
                 // Immediately stop the test stream
                 testStream.getTracks().forEach(track => track.stop());
                 
                 updateStatus('Camera permissions working! You can now start the camera.', 'success');
                 
             } catch (error) {
                 console.error('Permission test error:', error);
                 updateStatus(`Permission test failed: ${error.message}`, 'error');
             }
         }
         
         function updateStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status-${type}`;
        }
        
        function updateDetections(detections) {
            if (detections.length === 0) {
                detectionsList.innerHTML = '<em>No cards detected</em>';
                return;
            }
            
            detectionsList.innerHTML = detections.map(det => `
                <div class="detection-item">
                    <div class="detection-label">${det.class_name}</div>
                    <div class="detection-confidence">Confidence: ${(det.confidence * 100).toFixed(1)}%</div>
                    <div class="detection-confidence">Box: (${det.box.x1.toFixed(0)}, ${det.box.y1.toFixed(0)}) to (${det.box.x2.toFixed(0)}, ${det.box.y2.toFixed(0)})</div>
                </div>
            `).join('');
        }
        
                 async function startCamera() {
             try {
                 updateStatus('Checking camera permissions...', 'info');
                 
                 // Check if permissions API is available
                 if (navigator.permissions && navigator.permissions.query) {
                     try {
                         const permission = await navigator.permissions.query({ name: 'camera' });
                         console.log('Camera permission state:', permission.state);
                         
                         if (permission.state === 'denied') {
                             updateStatus('Camera access denied. Please enable camera permissions in your browser settings.', 'error');
                             return;
                         }
                     } catch (permError) {
                         console.log('Permissions API not available, proceeding with getUserMedia');
                     }
                 }
                 
                 // Ensure mediaDevices is available
                 if (!navigator.mediaDevices) {
                     navigator.mediaDevices = {};
                 }
                 
                 // Ensure getUserMedia is available
                 if (!navigator.mediaDevices.getUserMedia) {
                     navigator.mediaDevices.getUserMedia = function(constraints) {
                         const getUserMedia = navigator.webkitGetUserMedia || 
                                            navigator.mozGetUserMedia || 
                                            navigator.msGetUserMedia;
                         
                         if (!getUserMedia) {
                             return Promise.reject(new Error('getUserMedia is not supported in this browser'));
                         }
                         
                         return new Promise(function(resolve, reject) {
                             getUserMedia.call(navigator, constraints, resolve, reject);
                         });
                     }
                 }
                 
                 updateStatus('Requesting camera access...', 'info');
                 
                 // Try different camera constraints
                 const constraints = {
                     video: {
                         width: { ideal: 640, min: 320 },
                         height: { ideal: 480, min: 240 },
                         facingMode: 'environment' // Try back camera first
                     }
                 };
                 
                 try {
                     stream = await navigator.mediaDevices.getUserMedia(constraints);
                 } catch (envError) {
                     console.log('Back camera failed, trying any camera:', envError);
                     // Fallback to any camera
                     stream = await navigator.mediaDevices.getUserMedia({
                         video: {
                             width: { ideal: 640, min: 320 },
                             height: { ideal: 480, min: 240 }
                         }
                     });
                 }
                 
                 if (!stream) {
                     throw new Error('No camera stream received');
                 }
                 
                 console.log('Camera stream obtained:', stream);
                 
                 video.srcObject = stream;
                 
                 // Wait for video to be ready
                 await new Promise((resolve, reject) => {
                     const timeout = setTimeout(() => {
                         reject(new Error('Video loading timeout'));
                     }, 10000); // 10 second timeout
                     
                     video.onloadedmetadata = () => {
                         clearTimeout(timeout);
                         video.play().then(resolve).catch(reject);
                     };
                     
                     video.onerror = () => {
                         clearTimeout(timeout);
                         reject(new Error('Video loading failed'));
                     };
                 });
                 
                 startBtn.disabled = true;
                 stopBtn.disabled = false;
                 toggleDetectionBtn.disabled = false;
                 updateStatus('Camera started successfully', 'success');
                 
             } catch (error) {
                 console.error('Camera error:', error);
                 
                 let errorMessage = 'Camera access failed. ';
                 if (error.name === 'NotAllowedError') {
                     errorMessage += 'Please allow camera access when prompted.';
                 } else if (error.name === 'NotFoundError') {
                     errorMessage += 'No camera found on this device.';
                 } else if (error.name === 'NotReadableError') {
                     errorMessage += 'Camera is already in use by another application.';
                 } else {
                     errorMessage += error.message;
                 }
                 
                 updateStatus(errorMessage, 'error');
             }
         }
        
        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            startBtn.disabled = false;
            stopBtn.disabled = true;
            toggleDetectionBtn.disabled = true;
            isDetecting = false;
            updateStatus('Camera stopped', 'info');
            detectionsList.innerHTML = 'No detections yet';
        }
        
        function toggleDetection() {
            if (isDetecting) {
                if (detectionInterval) {
                    clearInterval(detectionInterval);
                    detectionInterval = null;
                }
                isDetecting = false;
                toggleDetectionBtn.textContent = 'Start Detection';
                updateStatus('Detection stopped', 'info');
            } else {
                isDetecting = true;
                toggleDetectionBtn.textContent = 'Stop Detection';
                updateStatus('Detection started - processing frames...', 'success');
                
                detectionInterval = setInterval(() => {
                    if (frameCount % maxFps === 0) {
                        captureAndSendFrame();
                    }
                    frameCount++;
                }, 1000 / maxFps);
            }
        }
        
        function captureAndSendFrame() {
            if (!video.videoWidth || !video.videoHeight) return;
            
            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Draw video frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const frameData = canvas.toDataURL('image/jpeg', 0.8);
            
            // Send to server
            fetch('/process_frame', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ frame: frameData })
            }).catch(error => {
                console.error('Error sending frame:', error);
            });
        }
        
        // Poll for detections
        function pollDetections() {
            fetch('/get_detections')
                .then(response => response.json())
                .then(data => {
                    updateDetections(data.detections);
                })
                .catch(error => {
                    console.error('Error fetching detections:', error);
                });
        }
        
                 // Event listeners
         startBtn.addEventListener('click', startCamera);
         stopBtn.addEventListener('click', stopCamera);
         toggleDetectionBtn.addEventListener('click', toggleDetection);
         testPermissionsBtn.addEventListener('click', testPermissions);
         
         // Check browser compatibility on page load
         checkBrowserCompatibility();
         
         // Debug: Make sure the test permissions button is visible
         console.log('Test permissions button:', testPermissionsBtn);
         if (testPermissionsBtn) {
             testPermissionsBtn.style.backgroundColor = '#ff6b35'; // Orange color to make it stand out
             console.log('Test permissions button is visible and styled');
         } else {
             console.error('Test permissions button not found!');
         }
        
        // Poll for detections every 500ms
        setInterval(pollDetections, 500);
        
        // Handle page unload
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>
